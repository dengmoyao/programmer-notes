# CAP 理论

## 概述

CAP 理论： 一个分布式系统最多只能满足一致性(Consistency)、可用性(Availability)和分区容错性(Partition tolerance)这三项中的两项

### Consistency 一致性

一致性指 “all the node see the same data at the same time”，即更新操作成功并返回客户端完成后，所有节点在同一时间的数据完全一致，所以，一致性，说的是数据的一致性。

对于一致性，可以分为客户端和服务端两个视角来看：

+ 从客户端来看： 一致性主要指的是多并发访问时，更新过的数据如何获取的问题
+ 从服务端来看：更新如何复制分布到整个系统，以保证数据最终一致

三种一致性策略：

+ 对于关系性数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性
+ 如果能容忍后续的部分或者全部访问不到，则是弱一致性
+ 如果要求一段时间后能访问到更新后的数据，则是最终一致性

### Availability 可用性

可用性指 “reads and writes always succeed”，即服务一致可用，而且是正常的响应时间。

一般在衡量一个系统可用性的时候，都是通过停机时间来计算的

### Partition Tolerance 分区容错性

分区容错性是指 “the system continues to operate despite arbitrary message loss or failure of part of the system”，即分布式系统在遇到某节点或者网络分区故障时，仍然能够对外提供满足一致性和可用性的服务。

## CAP 权衡

### CA without P

这种情况在分布式系统中几乎不存在的。在分布式环境下，网络分区是一个自然的事实，所以如果舍弃P，意味着要舍弃分布式系统。

无法通过降低CA来提升P，要提升系统的分区容错性，需要提升基础设施的稳定性来保证。

所以CAP并不是三选二，而是在P的前提下做CA的trade-off。

### CP without A

如果一个分布式系统不要求强的可用性，即容许系统停机或者长时间无响应的化，就可以在CAP三者中保障CP而舍弃A。

一个保证CP而舍弃A的分布式系统，一旦发生网络故障或消息丢失的情况，就要牺牲用户的体验，等待所有的数据全部一致了之后再让用户访问系统。

例子： 分布式数据库，Zookeeper

### AP without C

要高可用并允许分区，则需要放弃强一致性。一旦网络问题发生，节点之间可能会失去联系，为了保证高可用，需要再用户访问时马上得到返回，则每个节点只能用本地数据提供服务，而这样会导致全局数据不一致。

舍弃强一致性，但还是要保证最终一致性的。

例子： DNS